---
layout: post
title: PostgREST on RHEL 7.2
date: '2016-05-03T08:20:00.000+02:00'
author: Gerald O'Sullivan
tags:
- SELinux
- RHEL
- PostgreSQL
- PostgREST
modified_time: '2017-07-29T09:34:46.754+02:00'
thumbnail: https://4.bp.blogspot.com/-qrcBm0ypMmQ/Vyg75CEC1cI/AAAAAAAABuU/reA79UT6caoyr8GMV9znLBcWV0y55wOOwCLcB/s72-c/PostGrest_3.jpg
blogger_id: tag:blogger.com,1999:blog-5063526183496324043.post-1823704426708795882
blogger_orig_url: https://surfacedetail.blogspot.com/2016/05/postgrest-on-rhel-7-server.html
---

<a href="http://postgrest.com/">PostgREST</a> is an HTTP server written in Haskell that serves a fully RESTful API from a PostgreSQL database. It generates the endpoints directly from the database schema so you do not have to write anything from scratch. You just download the binary, fire it up with a database connection string and you are good to go.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-qrcBm0ypMmQ/Vyg75CEC1cI/AAAAAAAABuU/reA79UT6caoyr8GMV9znLBcWV0y55wOOwCLcB/s1600/PostGrest_3.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="269" src="https://4.bp.blogspot.com/-qrcBm0ypMmQ/Vyg75CEC1cI/AAAAAAAABuU/reA79UT6caoyr8GMV9znLBcWV0y55wOOwCLcB/s640/PostGrest_3.jpg" width="512" /></a></div><br />You won't find it as a .deb or .rpm package at the time of writing, so you have to <a href="http://postgrest.com/install/server/">install it manually</a> and create your own startup scripts.<br /><br />In this post I will describe how to do this on a Redhat Enterprise Linux (RHEL 7.2) server in a managed SELinux context. The PostgreSQL database instance runs on the same server in this example.<br /><br />Note that RHEL 7.2 ships with PostgreSQL 9.2 which is not supported by PostgREST so you have to upgrade to version 9.3 or later from the <a href="http://www.postgresql.org/download/linux/redhat/">PostgreSQL repositories</a>.<br /><br /><h2>Download, install and test the binary&nbsp;</h2>Download the tarball from <a href="https://github.com/begriffs/postgrest/releases/latest">the github repo</a>. Select the Centos binary for compatibility with RHEL, then untar it and move it to a directory on the load path:<br /><pre class="prettyprint"># tar -xvf postgrest-0.3.1.1-centos.tar.xz<br /># mv postgrest /usr/bin/postgrest<br /></pre><span style="font-family: inherit;">Test the installation of the binary by invoking the --help dialogue:</span><br /><pre class="prettyprint"># postgrest --help<br />Usage: postgrest DB_URL (-a|--anonymous ROLE) [-s|--schema NAME]<br />&nbsp;&nbsp;&nbsp;&nbsp;[-p|--port PORT] [-j|--jwt-secret SECRET] [-o|--pool COUNT]<br />&nbsp;&nbsp;&nbsp;&nbsp;[-m|--max-rows COUNT]<br />&nbsp;&nbsp;PostgREST 0.3.1.1 / create a REST API to an existing Postgres database<br /></pre><span style="font-family: inherit;">Now that you have confirmed that PostgREST is accessible, create a test database called 'demo1' by following the <a href="http://postgrest.com/examples/start/">Getting Started instructions here</a>, or use an existing database, and run PostgREST:</span><br /><pre class="prettyprint"># postgrest postgres://postgres:my_pass@localhost:5432/demo1 -a postgres -p 5438<br />&nbsp;&nbsp;&nbsp;WARNING, running in insecure mode, JWT secret is the default value<br />&nbsp;&nbsp;&nbsp;Listening on port 5438<br /></pre>where:<br /><ul><li><b><i>postgres:my_pass</i></b> is the authenticator role (with password 'my_pass') that handles the initial HTTP requests. For the purposes of this example, it is the default PostgreSQL role;&nbsp;</li><li><b><i>demo1</i></b>&nbsp;is the name of the test database that will be exposed by the API;&nbsp;</li><li><b><i>-a postgres</i></b>&nbsp;is the name of the role that will handle unauthenticated anonymous requests; and</li><li><b><i>-p 5438</i></b> is the port number that PostgREST will use to listen to HTTP requests. Note that by default PostgREST uses port 3000, but this port is managed by SELinux for other purposes, so use 5438 instead because it is unmanaged, and it is close to the default PostgreSQL port number so it is easy to remember.&nbsp;</li></ul><br />Send a simple HTTP GET request to the PostgREST port 5438:<br /><pre class="prettyprint"># curl http://localhost:5438</pre>If all is well, PostgREST will return a JSON string with a list of tables and views that are accessible in the database schema:<br /><br /><div style="line-height: 1.656; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: transparent; font-family: monospace; font-size: 10px; font-style: normal; font-variant: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">[{"schema":"public","name":"competition","insertable":true},{"schema":"public","name":"director","insertable":true},{"schema":"public","name":"festival","insertable":true},{"schema":"public","name":"film","insertable":true},{"schema":"public","name":"film_nomination","insertable":true}]</span></div><br />It's that straight forward!<br /><br /><h2>Open the firewall&nbsp;</h2>The RHEL firewall on the server will block access from the network to the server, so we have to add the PostgREST port 5438 to the public zone and make it permanently available:<br /><pre class="prettyprint"># firewall-cmd --zone=public --add-port=5438/tcp --permanent</pre>Reload the firewall and check that the port is open:<br /><pre class="prettyprint"># firewall-cmd --reload<br /># firewall-cmd --zone=public --list-ports<br />&nbsp;&nbsp;&nbsp;443/tcp 139/tcp 22/tcp 5432/tcp <strong>5438/tcp</strong> 80/tcp 445/tcp 137/tcp</pre>Now you should be able to access the API from a client workstation (where <b>my_server_IP</b>&nbsp;is the hostname or IP address of your PostgREST server):<br /><pre class="prettyprint"># curl http://my_server_IP:5438</pre><h2>Create a systemd service</h2><div>RHEL 7.2 uses systemd to manage the initialisation of services (yes, <a href="https://devuan.org/">haters</a> gonna hate), so create a system user to run the service and define a custom systemd service to automate the startup of PostgREST.<br /><br />Create a system user <b>postgrest</b>&nbsp;with no login shell to run the PostgREST daemon:<br /><pre class="prettyprint"># useradd -r -s /usr/bin/nologin postgrest</pre>and create a service description <b>/usr/lib/systemd/system/postgrest.service</b> with the following contents:</div><pre class="prettyprint">[Unit]<br />Description=PostgREST Service<br />After=postgresql-9.5.service<br /><br />[Service]<br />User=postgrest<br />Group=postgrest<br />ExecStart=/usr/bin/postgrest postgres://postgres:my_pass@localhost:5432/demo1 -a postgres -p 5438<br /><br />[Install]<br />WantedBy=multi-user.target</pre>Note that the entry '<span style="font-family: monospace; font-size: 10px; white-space: pre-wrap;">After=postgresql-9.5.service' </span>will cause the service to start after the initialisation of the database instance has been completed.<br /><div><br />Enable the service and start it:<br /><pre class="prettyprint"># systemctl enable postgrest<br /># systemctl start postgrest</pre></div>It should now start automatically when the server starts up. <br /><div><br /></div><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="license"><img alt="Creative Commons License" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" style="border-width: 0;" /></a><br /><span property="dct:title" xmlns:dct="http://purl.org/dc/terms/">PostgREST API diagram</span> by <span property="cc:attributionName" xmlns:cc="http://creativecommons.org/ns#">Taung Technologies</span> is licensed under a <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="license">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.